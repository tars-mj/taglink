# ADR 011.3: UI/UX Improvements and React Query Integration

**Status:** Accepted
**Date:** 2025-01-06
**Decision Makers:** Development Team
**Related ADRs:** [011.2 Data Caching with React Query](011.2-data-caching-with-react-query.md)

## Context

After implementing React Query for data caching (ADR 011.2), we identified several UI/UX issues and incomplete React Query integration that affected user experience:

1. **Search Functionality Missing**: Dashboard lacked search capability for filtering links by title/description
2. **Statistics Panel Visibility**: Panel disappeared when filters were active, reducing visibility into link statistics
3. **Visual Inconsistencies**:
   - Poor contrast in Keyboard Shortcuts modal
   - Inconsistent header heights across pages
   - Content shift when scrollbar appeared/disappeared
4. **Button UX Issues**: Missing cursor pointer and improper Link integration
5. **Modal Usability**: Edit Link Dialog had scrolling issues and lacked full URL display
6. **Skeleton Loading**: Not adaptive to user's selected view mode (grid vs list)
7. **Link Card Responsiveness**: Long titles overflowed and hover effects were too aggressive
8. **React Query Integration**: Add Link Dialog still used server actions instead of mutation hooks, causing new links to not appear without page refresh

## Decision

We implemented comprehensive UI/UX improvements and completed React Query integration:

### 1. Dashboard Search Implementation

**Added debounced search functionality:**

```typescript
// src/app/dashboard/page.tsx
const [searchInput, setSearchInput] = useState(query)

// Sync with URL
useEffect(() => {
  setSearchInput(query)
}, [query])

// Debounce 600ms
useEffect(() => {
  const timeoutId = setTimeout(() => {
    if (searchInput !== query) {
      updateUrlParams({ q: searchInput, page: 1 })
    }
  }, 600)
  return () => clearTimeout(timeoutId)
}, [searchInput, query, updateUrlParams])
```

**UI Implementation:**
```tsx
<div className="relative flex-1">
  <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
  <Input
    type="text"
    placeholder="Szukaj w tytułach i opisach..."
    value={searchInput}
    onChange={(e) => setSearchInput(e.target.value)}
    className="pl-9"
  />
</div>
```

**Benefits:**
- 600ms debounce prevents excessive API calls
- URL-based state management for shareable searches
- Consistent styling with Tags page
- Real-time feedback without lag

### 2. Statistics Panel Persistence

**Made statistics panel always visible:**

```typescript
// Before: Conditional rendering
{!hasActiveFilters && searchResult && searchResult.totalCount > 0 && (
  <LinkStatisticsPanel />
)}

// After: Always visible
<LinkStatisticsPanel />
```

**Benefits:**
- Users can always see their link statistics
- No jarring layout shifts when applying/removing filters
- Better information architecture

### 3. Visual Consistency Improvements

#### 3.1 Keyboard Shortcuts Modal Redesign

**Improved contrast and readability:**

```tsx
// Section headers with better contrast
<h3 className="mb-3 text-sm font-semibold text-slate-900 uppercase tracking-wide dark:text-slate-400">
  Global Shortcuts
</h3>

// Background for better grouping
<div className="space-y-1 bg-slate-50 rounded-md p-3 dark:bg-slate-800">
  {shortcuts.global.map(...)}
</div>

// ShortcutRow with improved styling
<div className="flex items-center justify-between py-2 px-2 rounded hover:bg-white/60 dark:hover:bg-slate-700/30 transition-colors">
  <span className="text-sm text-slate-800 dark:text-slate-200">{description}</span>
  <kbd className="inline-flex items-center gap-1 rounded-md border-2 border-slate-300 bg-white px-2.5 py-1 font-mono text-xs font-bold text-slate-800 shadow-sm dark:border-slate-600 dark:bg-slate-900 dark:text-slate-200">
    {shortcut}
  </kbd>
</div>
```

**Changes:**
- Slate color scheme for better contrast
- Background boxes for visual grouping
- Improved badge styling with borders and shadows
- Gradient tip section for better visual hierarchy

#### 3.2 Header Height Consistency

**Unified all page headers:**

```tsx
// Standardized structure across all pages
<div className="bg-gradient-main text-white">
  <div className="container mx-auto px-4 py-8">
    <div className="flex items-center gap-3 mb-2">
      <Icon className="h-8 w-8" />
      <h1 className="text-3xl font-bold">Title</h1>
    </div>
    <div className="min-h-[1.5rem]">
      <p className="text-white/90">Description</p>
    </div>
  </div>
</div>
```

**Applied to:**
- Dashboard page
- Tags page
- Profile page
- Settings page

#### 3.3 Scrollbar Layout Shift Prevention

**Added permanent scrollbar reservation:**

```tsx
// src/app/layout.tsx
<html lang="pl" suppressHydrationWarning className="overflow-y-scroll">
```

**Benefits:**
- No horizontal content shift between pages
- Consistent viewport width
- Better visual stability

### 4. Button UX Improvements

#### 4.1 Cursor Pointer

**Added to all buttons:**

```typescript
// src/components/ui/button.tsx
const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 cursor-pointer",
  // ...
)
```

#### 4.2 Next.js Link Integration

**Refactored navbar to use asChild pattern:**

```tsx
// Before: Button wrapping Link
<Link href="/dashboard">
  <Button>Dashboard</Button>
</Link>

// After: Radix UI Slot pattern
<Button asChild variant="ghost" size="sm">
  <Link href="/dashboard">
    <LayoutDashboard className="h-4 w-4 mr-2" />
    Dashboard
  </Link>
</Button>
```

**Benefits:**
- Proper semantic HTML (single `<a>` tag)
- Better accessibility
- Correct Next.js prefetching
- No nested interactive elements

### 5. Edit Link Dialog Improvements

**Enhanced usability:**

```tsx
// Full URL display (read-only)
<div className="grid gap-2">
  <Label className="text-xs text-muted-foreground">URL</Label>
  <p className="text-sm text-slate-700 dark:text-slate-300 break-all bg-slate-50 dark:bg-slate-800 rounded-md px-3 py-2 border border-slate-200 dark:border-slate-700">
    {link.url}
  </p>
</div>

// Removed scroll from modal (DialogContent)
<DialogContent className="sm:max-w-[525px]">  {/* No max-h or overflow */}

// Compact textarea
<Textarea rows={3} className="resize-none" maxLength={280} />

// Scrollable tags section only
<div className="border rounded-md p-3 max-h-[160px] overflow-y-auto">
  {/* tags */}
</div>
```

**Improvements:**
- Full URL visibility for verification
- No modal scrolling (only tags section scrolls)
- Compact layout with appropriate max-heights
- Better user focus on editable fields

### 6. Adaptive Skeleton Loading

**Made skeletons responsive to view mode:**

```typescript
// src/components/skeletons/link-card-skeleton.tsx
interface LinkCardSkeletonProps {
  viewMode?: DefaultView
}

export function LinkCardSkeleton({ viewMode = 'grid' }: LinkCardSkeletonProps) {
  // List view - compact horizontal layout
  if (viewMode === 'list') {
    return (
      <Card>
        <CardContent className="p-4">
          <div className="flex items-center gap-4">
            {/* Horizontal skeleton layout */}
          </div>
        </CardContent>
      </Card>
    )
  }

  // Grid view - vertical card layout
  return <Card>{/* ... */}</Card>
}

export function LinkCardSkeletonGrid({ count = 6, viewMode = 'grid' }) {
  return (
    <div className={
      viewMode === 'grid'
        ? 'grid gap-4 md:grid-cols-2 lg:grid-cols-3'
        : 'flex flex-col gap-3'
    }>
      {[...Array(count)].map((_, i) => (
        <LinkCardSkeleton key={i} viewMode={viewMode} />
      ))}
    </div>
  )
}
```

**Usage:**
```tsx
// Dashboard passes user's view preference
{isLoading && <LinkCardSkeletonGrid count={6} viewMode={viewMode} />}
```

### 7. Link Card Responsiveness Fixes

#### 7.1 Title Truncation

**Grid View:**
```tsx
<div className="flex justify-between items-start gap-2">
  <div className="flex-1 min-w-0">  {/* Enable truncation */}
    <a className="text-lg font-semibold text-blue-600 hover:text-blue-800 flex items-center gap-1">
      <span className="truncate">{link.title || link.domain}</span>
      <ExternalLink className="h-4 w-4 flex-shrink-0" />  {/* Prevent icon squish */}
    </a>
  </div>
  <div className="flex items-center gap-1 flex-shrink-0">  {/* Prevent button overlap */}
    <EditLinkDialog />
    <DeleteLinkButton />
  </div>
</div>
```

**List View:**
```tsx
<div className="flex-1 min-w-0">
  <a className="text-base font-semibold text-blue-600 hover:text-blue-800 flex items-center gap-1 max-w-full">
    <span className="truncate flex-1">{link.title || link.domain}</span>
    <ExternalLink className="h-3.5 w-3.5 flex-shrink-0" />
  </a>
</div>
```

**Key CSS Patterns:**
- `min-w-0` on flex parent: Enables truncation in flex containers
- `truncate` on text span: Adds `overflow: hidden; text-overflow: ellipsis; white-space: nowrap`
- `flex-shrink-0` on icons/buttons: Prevents squishing

#### 7.2 Reduced Hover Effect

**Subtle scale transition:**
```tsx
// Before: Too aggressive
<Card className="hover:scale-[1.02]">

// After: Very subtle
<Card className="hover:scale-[1.005]">
```

### 8. React Query Integration Completion

**Migrated Add Link Dialog from Server Actions to Mutation Hook:**

#### Before (Server Actions):
```typescript
// src/components/links/add-link-dialog.tsx
import { createLink } from '@/app/actions/links'
const [isPending, startTransition] = useTransition()
const router = useRouter()

const handleSubmit = async (e) => {
  startTransition(async () => {
    const result = await createLink(formData)
    if (result.success) {
      router.refresh()  // Manual refresh required
      window.dispatchEvent(new CustomEvent('link-added'))
    }
  })
}
```

#### After (React Query Mutation):
```typescript
// src/components/links/add-link-dialog.tsx
import { useCreateLink } from '@/hooks/queries/use-links'
const createLinkMutation = useCreateLink()

const handleSubmit = async (e) => {
  createLinkMutation.mutate(formData, {
    onSuccess: (result) => {
      setUrl('')
      setTitle('')
      setOpen(false)
      refreshRateLimit()
      // Cache automatically invalidated by hook
    },
    onError: () => {
      refreshRateLimit()
    },
  })
}

// Use mutation state
disabled={createLinkMutation.isPending}
{createLinkMutation.isPending ? 'Processing with AI...' : 'Add Link'}
```

#### Enhanced Hook with Toast Notifications:
```typescript
// src/hooks/queries/use-links.ts
export function useCreateLink() {
  const queryClient = useQueryClient()
  const { toast } = useToast()

  return useMutation({
    mutationFn: async (formData: FormData) => {
      const result = await createLink(formData)
      if (!result.success) {
        throw new Error(result.error || 'Failed to create link')
      }
      return result
    },
    onSuccess: (result) => {
      // Automatic cache invalidation
      queryClient.invalidateQueries({ queryKey: queryKeys.links.all })
      queryClient.invalidateQueries({ queryKey: queryKeys.links.statistics })
      queryClient.invalidateQueries({ queryKey: queryKeys.user.stats })

      const linkTitle = result.data?.title || 'Link'
      toast({
        title: 'Link added!',
        description: `"${linkTitle}" has been saved with AI-generated description and tags.`,
      })
    },
    onError: (error: Error) => {
      toast({
        title: 'Error',
        description: error.message,
        variant: 'destructive',
      })
    },
  })
}
```

**Benefits of React Query Approach:**

1. **Automatic Cache Invalidation**: No manual refresh needed
2. **Optimistic Updates**: UI updates immediately
3. **Centralized State**: Single source of truth for mutations
4. **Error Recovery**: Built-in retry and error handling
5. **Loading States**: Consistent pending state management
6. **Type Safety**: Full TypeScript support
7. **Reduced Boilerplate**: No useTransition, useRouter needed

**Cache Invalidation Strategy:**

According to TanStack Query best practices:
- `invalidateQueries` marks queries as stale
- Automatically refetches all active queries with matching keys
- Prefix matching: `['links']` invalidates `['links', { page: 1 }]`
- Background refetch prevents stale data

## Consequences

### Positive

1. **Better Search UX**:
   - 600ms debounce prevents API spam
   - URL-based state enables sharing search results
   - Consistent UI across Dashboard and Tags pages

2. **Improved Information Architecture**:
   - Statistics panel always visible
   - No layout shifts during filtering
   - Better data visibility

3. **Enhanced Visual Consistency**:
   - Better contrast ratios for accessibility
   - Consistent header heights across all pages
   - No layout shift from scrollbar appearance

4. **Better Button Affordances**:
   - Cursor pointer improves discoverability
   - Proper Link integration for accessibility
   - Correct semantic HTML structure

5. **Modal Usability**:
   - Full URL visibility for user confidence
   - No confusing modal scrolling
   - Better focus on editable fields

6. **Loading State Accuracy**:
   - Skeletons match actual content layout
   - Reduces Cumulative Layout Shift (CLS)
   - Better perceived performance

7. **Responsive Design**:
   - Long titles properly truncated
   - No text overflow or element overlap
   - Subtle, professional hover effects

8. **Reactive Data Flow**:
   - New links appear immediately without refresh
   - Automatic cache synchronization
   - Consistent loading states
   - Centralized mutation logic

9. **Developer Experience**:
   - Less boilerplate code
   - Type-safe mutations
   - Built-in error handling
   - Easier to test and maintain

### Negative

1. **Increased Complexity**:
   - More CSS utility classes to maintain
   - Flexbox truncation patterns require understanding
   - React Query mutation patterns require learning

2. **Performance Considerations**:
   - Search debouncing adds 600ms delay
   - Skeleton components add initial render time
   - Multiple `invalidateQueries` calls on mutation

3. **Migration Effort**:
   - Other dialogs still use server actions pattern
   - Need to migrate EditLinkDialog, DeleteLinkButton
   - Inconsistent mutation patterns during transition

### Neutral

1. **Maintenance Burden**:
   - More components to keep in sync
   - Skeleton components must match actual layout
   - Need to maintain both loading and loaded states

2. **Testing Requirements**:
   - Need tests for debounced search
   - Skeleton component visual regression tests
   - Truncation behavior across different content lengths
   - React Query cache invalidation tests

## Implementation Notes

### Search Debouncing Pattern

The debouncing implementation uses two useEffect hooks:
1. **Sync Effect**: Updates local state when URL changes
2. **Debounce Effect**: Updates URL after 600ms idle

This prevents infinite loops while maintaining URL as source of truth.

### Flexbox Truncation

For truncation to work in flexbox:
1. Parent must have `min-w-0` (resets min-width: auto)
2. Text element needs `truncate` class
3. Icons/buttons need `flex-shrink-0`

### React Query Cache Keys

Cache invalidation uses hierarchical keys:
```typescript
queryKeys.links.all        // Invalidates all link queries
queryKeys.links.list(...)  // Specific query with params
```

Prefix matching means invalidating `['links']` will invalidate:
- `['links']`
- `['links', { page: 1 }]`
- `['links', { query: 'test' }]`
- etc.

## Related Documentation

- [TanStack Query - Invalidations from Mutations](https://tanstack.com/query/latest/docs/framework/react/guides/invalidations-from-mutations)
- [TanStack Query - Query Invalidation](https://tanstack.com/query/latest/docs/framework/react/guides/query-invalidation)
- [Radix UI Slot](https://www.radix-ui.com/primitives/docs/utilities/slot)
- [CSS Truncation in Flexbox](https://css-tricks.com/flexbox-truncated-text/)
- [ADR 011.2 - Data Caching with React Query](011.2-data-caching-with-react-query.md)

## Migration Path

### Completed
- ✅ Dashboard search implementation
- ✅ Statistics panel persistence
- ✅ Visual consistency improvements
- ✅ Button UX fixes
- ✅ Modal usability enhancements
- ✅ Adaptive skeleton loading
- ✅ Link card responsiveness
- ✅ Add Link Dialog React Query integration

### Pending
- ⏳ Migrate EditLinkDialog to `useUpdateLink` mutation hook
- ⏳ Migrate DeleteLinkButton to `useDeleteLink` mutation hook
- ⏳ Migrate CreateTagDialog to React Query mutation
- ⏳ Add optimistic updates for better UX
- ⏳ Implement error boundaries for mutation failures

## Alternatives Considered

### For Search
- **Client-side filtering**: Rejected due to pagination
- **Real-time search**: Rejected due to API cost concerns
- **300ms debounce**: Rejected as too fast, causes API spam

### For Scrollbar
- **Custom scrollbar**: Rejected due to cross-browser complexity
- **Hide scrollbar**: Rejected due to accessibility concerns

### For Mutations
- **Keep Server Actions**: Rejected due to manual refresh requirement
- **Optimistic Updates Only**: Rejected as risky without server confirmation
- **Custom fetch hooks**: Rejected due to reinventing React Query features

## Success Metrics

1. **Search Usage**: Track search query frequency
2. **User Satisfaction**: Reduced complaints about missing features
3. **Performance**: Measure CLS improvement from layout fixes
4. **Developer Velocity**: Faster feature implementation with React Query
5. **Cache Hit Rate**: Monitor React Query cache effectiveness
6. **Error Rate**: Track mutation success/failure rates

## Migration Path

### Completed (2025-01-06)
- ✅ Dashboard search implementation
- ✅ Statistics panel persistence
- ✅ Visual consistency improvements
- ✅ Button UX fixes
- ✅ Modal usability enhancements
- ✅ Adaptive skeleton loading
- ✅ Link card responsiveness
- ✅ Add Link Dialog React Query integration (`useCreateLink`)
- ✅ Edit Link Dialog React Query integration (`useUpdateLink`)
- ✅ Delete Link Button React Query integration (`useDeleteLink`)

### Pending
- ⏳ Migrate CreateTagDialog to React Query mutation
- ⏳ Add optimistic updates for better UX
- ⏳ Implement error boundaries for mutation failures
- ⏳ Create mutation hooks for tag operations (create, update, delete)

## Version

- **Created**: 2025-01-06
- **Updated**: 2025-01-06
- **Version**: 1.1
- **Authors**: Development Team
